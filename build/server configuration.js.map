{"version":3,"sources":["../source/server configuration.js"],"names":["server_configuration","is_external","webpack_configuration","settings","context","Error","configuration","output_file_name","basename","server","output","extname","entry","input","target","node","__dirname","__filename","libraryTarget","filename","chunkFilename","pathinfo","path","resolve","dirname","devtool","externals","push","request","callback","loader","style_loader","loaders","filter","fake_style_loader","name","indexOf","plugins","plugin","constructor","HotModuleReplacementPlugin","optimize","CommonsChunkPlugin","concat","LimitChunkCountPlugin","maxChunks","package_name","substring","validForNewPackages","alias","exclude_from_externals","exclusion_pattern","regexp","RegExp","test"],"mappings":"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","file":"server configuration.js","sourcesContent":["import path from 'path'\r\nimport webpack from 'webpack'\r\nimport validate_npm_package_path from 'validate-npm-package-name'\r\n\r\nimport { clone, starts_with } from './helpers'\r\nimport { find_style_loaders, is_style_loader, parse_loader, stringify_loader } from './loaders'\r\n\r\n// Tunes the client-side Webpack configuration for server-side build\r\nexport default function server_configuration(webpack_configuration, settings)\r\n{\r\n\tif (!webpack_configuration.context)\r\n\t{\r\n\t\tthrow new Error(`You must set \"context\" parameter in your Webpack configuration`)\r\n\t}\r\n\r\n\tconst configuration = clone(webpack_configuration)\r\n\r\n\t// (without extension)\r\n\tconst output_file_name = path.basename(settings.server.output, path.extname(settings.server.output))\r\n\r\n\tconfiguration.entry =\r\n\t{\r\n\t\t[output_file_name]: settings.server.input\r\n\t}\r\n\r\n\t// https://webpack.github.io/docs/configuration.html#target\r\n\tconfiguration.target = 'node'\r\n\r\n\t// Tell Webpack to leave `__dirname` and `__filename` unchanged\r\n\t// https://github.com/webpack/webpack/issues/1599#issuecomment-186841345\r\n\tconfiguration.node =\r\n\t{\r\n\t\t__dirname  : false,\r\n\t\t__filename : false\r\n\t}\r\n\r\n\t// https://webpack.github.io/docs/configuration.html#output-librarytarget\r\n\tconfiguration.output.libraryTarget = 'commonjs2'\r\n\r\n\t// No need for browser cache management, so disable hashes in filenames\r\n\tconfiguration.output.filename = '[name].js'\r\n\tconfiguration.output.chunkFilename = '[name].js'\r\n\r\n\t// Include comments with information about the modules.\r\n\t// require(/* ./test */23).\r\n\t// What for is it here? I don't know. It's a copy & paste from the Webpack author's code.\r\n\tconfiguration.output.pathinfo = true\r\n\r\n\t// Output server bundle into its own directory\r\n\tconfiguration.output.path = path.resolve(configuration.context, path.dirname(settings.server.output))\r\n\r\n\t// Output \"*.map\" file for human-readable stack traces\r\n\tconfiguration.devtool = 'source-map'\r\n\r\n\t// https://webpack.github.io/docs/configuration.html#externals\r\n\t//\r\n\t// `externals` allows you to specify dependencies for your library \r\n\t// that are not resolved by webpack, but become dependencies of the output. \r\n\t// This means they are imported from the environment during runtime.\r\n\t//\r\n\t// So that Webpack doesn't bundle \"node_modules\" into server.js.\r\n\r\n\tconfiguration.externals = configuration.externals || []\r\n\r\n\tconfiguration.externals.push(function(context, request, callback)\r\n\t{\r\n\t\tif (is_external(request, configuration, settings))\r\n\t\t{\r\n\t\t\t// Resolve dependency as external\r\n\t\t\treturn callback(null, request)\r\n\t\t}\r\n\r\n\t\t// Resolve dependency as non-external\r\n\t\treturn callback()\r\n\t})\r\n\r\n\t// Replace `style-loader` with `fake-style-loader`\r\n\t// since it's no web browser\r\n\tfor (let loader of find_style_loaders(configuration))\r\n\t{\r\n\t\tconst style_loader = loader.loaders.filter(is_style_loader)[0]\r\n\r\n\t\t// Copy `style-loader` configuration\r\n\t\tconst fake_style_loader = parse_loader(style_loader)\r\n\r\n\t\t// Since npm v3 enforces flat `node_modules` structure,\r\n\t\t// `fake-style-loader` is gonna be right inside `node_modules`\r\n\t\tfake_style_loader.name = 'fake-style-loader'\r\n\t\t// fake_style_loader.name = path.resolve(__dirname, '../node_modules/fake-style-loader')\r\n\r\n\t\t// Replace the loader\r\n\t\tloader.loaders[loader.loaders.indexOf(style_loader)] = stringify_loader(fake_style_loader)\r\n\t}\r\n\r\n\tconfiguration.plugins = configuration.plugins || []\r\n\r\n\t// Remove HotModuleReplacementPlugin and CommonsChunkPlugin\r\n\tconfiguration.plugins = configuration.plugins.filter(plugin =>\r\n\t{\r\n\t\treturn plugin.constructor !== webpack.HotModuleReplacementPlugin\r\n\t\t\t&& plugin.constructor !== webpack.optimize.CommonsChunkPlugin\r\n\t})\r\n\r\n\t// Add a couple of utility plugins\r\n\tconfiguration.plugins = configuration.plugins.concat\r\n\t(\r\n\t\t// Resorted from using it here because\r\n\t\t// if the `build/server` folder is not there\r\n\t\t// when Nodemon starts then it simply won't detect \r\n\t\t// updates of the server-side bundle\r\n\t\t// and therefore won't restart on code changes.\r\n\t\t//\r\n\t\t// `build/server` folder needs to be present\r\n\t\t// by the time Nodemon starts,\r\n\t\t// and that's accomplished with a separate npm script.\r\n\r\n\t\t// // Cleans the output folder\r\n\t\t// new clean_plugin([path.dirname(settings.server.output)],\r\n\t\t// {\r\n\t\t// \troot: configuration.context\r\n\t\t// }),\r\n\r\n\t\t// Put the resulting Webpack compiled code into a sigle javascript file\r\n\t\t// (doesn't disable CommonsChunkPlugin)\r\n\t\tnew webpack.optimize.LimitChunkCountPlugin({ maxChunks: 1 })\r\n\t)\r\n\r\n\t// Done\r\n\treturn configuration\r\n}\r\n\r\n// Checks if a require()d dependency is external\r\nexport function is_external(request, webpack_configuration, settings)\r\n{\r\n\t// Mark `node_modules` as external.\r\n\r\n\tlet package_name = request\r\n\tif (package_name.indexOf('/') >= 0)\r\n\t{\r\n\t\tpackage_name = package_name.substring(0, package_name.indexOf('/'))\r\n\t}\r\n\r\n\t// Skip webpack loader specific require()d paths\r\n\t// https://webpack.github.io/docs/loaders.html\r\n\tif (starts_with(package_name, '!') || starts_with(package_name, '-!'))\r\n\t{\r\n\t\t// The dependency is not external\r\n\t\treturn false\r\n\t}\r\n\r\n\t// If it's not a module require call,\r\n\t// then resolve it as non-external.\r\n\t//\r\n\t// https://github.com/npm/validate-npm-package-name\r\n\t//\r\n\tif (!validate_npm_package_path(package_name).validForNewPackages)\r\n\t{\r\n\t\t// The dependency is not external\r\n\t\treturn false\r\n\t}\r\n\r\n\t// If any aliases are specified, then resolve those aliases as non-external\r\n\tif (webpack_configuration.resolve && webpack_configuration.resolve.alias)\r\n\t{\r\n\t\tfor (let alias of Object.keys(webpack_configuration.resolve.alias))\r\n\t\t{\r\n\t\t\t// if (request === key || starts_with(request, key + '/'))\r\n\t\t\tif (package_name === alias)\r\n\t\t\t{\r\n\t\t\t\t// The module is not external\r\n\t\t\t\treturn false\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// Skip modules explicitly ignored by the user\r\n\tif (settings.exclude_from_externals)\r\n\t{\r\n\t\tfor (let exclusion_pattern of settings.exclude_from_externals)\r\n\t\t{\r\n\t\t\tlet regexp = exclusion_pattern\r\n\r\n\t\t\tif (typeof exclusion_pattern === 'string')\r\n\t\t\t{\r\n\t\t\t\tif (request === exclusion_pattern \r\n\t\t\t\t\t|| starts_with(request, exclusion_pattern + '/'))\r\n\t\t\t\t{\r\n\t\t\t\t\t// The module is not external\r\n\t\t\t\t\treturn false\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse if (exclusion_pattern instanceof RegExp)\r\n\t\t\t{\r\n\t\t\t\tif (regexp.test(request))\r\n\t\t\t\t{\r\n\t\t\t\t\t// The module is not external\r\n\t\t\t\t\treturn false\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\telse\r\n\t\t\t{\r\n\t\t\t\tthrow new Error(`Invalid exclusion pattern: ${exclusion_pattern}. Only strings and regular expressions are allowed.`)\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\t// The module is external\r\n\treturn true\r\n}"]}